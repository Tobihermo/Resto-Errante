{% extends "base.html" %}

{% block title %}Mis Reservas{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-list"></i> Mis Reservas</h2>
        
        <ul class="nav nav-tabs" id="myReservationsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="attending-tab" data-bs-toggle="tab" 
                        data-bs-target="#attending" type="button" role="tab">
                    <i class="fas fa-utensils"></i> Reservas a las que Asisto
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="created-tab" data-bs-toggle="tab" 
                        data-bs-target="#created" type="button" role="tab">
                    <i class="fas fa-plus-circle"></i> Reservas que Creé
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="myReservationsTabsContent">
            <div class="tab-pane fade show active" id="attending" role="tabpanel">
                {% if reservations %}
                    <div class="row">
                        {% for reservation in reservations %}
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 {% if reservation.is_cancelled %}border-danger{% endif %}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title">{{ reservation.title }}</h5>
                                        <div>
                                            {% if reservation.is_cancelled %}
                                                <span class="badge bg-danger">Cancelada</span>
                                            {% else %}
                                                {% if reservation.is_free %}
                                                    <span class="badge bg-success">Gratuita</span>
                                                {% else %}
                                                    <span class="badge bg-warning">${{ reservation.price }}</span>
                                                {% endif %}
                                                <span class="badge bg-info">{{ reservation.tickets_count }} entrada{% if reservation.tickets_count > 1 %}s{% endif %}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <p class="card-text">{{ reservation.short_description }}</p>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar"></i> {{ reservation.date[:16] }}<br>
                                            <i class="fas fa-map-marker-alt"></i> {{ reservation.location }}<br>
                                            <i class="fas fa-user"></i> Organizador: {{ reservation.creator_username }}<br>
                                            <i class="fas fa-utensils"></i> {{ reservation.event_type_name }}
                                        </small>
                                    </p>
                                    
                                    {% if reservation.food_selections %}
                                    <div class="mt-2">
                                        <small><strong>Comida seleccionada:</strong></small>
                                        <div class="food-selections">
                                            {% set food_data = reservation.food_selections %}
                                            {% if food_data is string %}
                                                {% set food_data = food_data|from_json %}
                                            {% endif %}
                                            {% for item_id, quantity in food_data.items() %}
                                                {% if quantity > 0 %}
                                                    {% set menu_item = menu_items_dict.get(item_id) %}
                                                    {% if menu_item %}
                                                        <small class="d-block">
                                                            {{ menu_item.name }} x{{ quantity }} - ${{ "%.2f"|format(menu_item.price * quantity) }}
                                                        </small>
                                                    {% else %}
                                                        <small class="d-block text-muted">
                                                            Producto no disponible x{{ quantity }}
                                                        </small>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <a href="{{ url_for('reservation_detail', reservation_id=reservation.id) }}" 
                                       class="btn btn-primary btn-sm">
                                        <i class="fas fa-eye"></i> Ver Detalles
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info text-center mt-4">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h4>No estás registrado en ninguna reserva</h4>
                        <p>Explora las reservas disponibles y únete a alguna.</p>
                        <a href="{{ url_for('index') }}" class="btn btn-primary">
                            <i class="fas fa-search"></i> Explorar Reservas
                        </a>
                    </div>
                {% endif %}
            </div>

            <div class="tab-pane fade" id="created" role="tabpanel">
                {% if created_reservations %}
                    <div class="row">
                        {% for reservation in created_reservations %}
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 {% if reservation.is_cancelled %}border-danger{% endif %}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title">{{ reservation.title }}</h5>
                                        <div>
                                            {% if reservation.is_cancelled %}
                                                <span class="badge bg-danger">Cancelada</span>
                                            {% else %}
                                                {% if reservation.is_free %}
                                                    <span class="badge bg-success">Gratuita</span>
                                                {% else %}
                                                    <span class="badge bg-warning">${{ reservation.price }}</span>
                                                {% endif %}
                                                {% if reservation.is_private %}
                                                    <span class="badge bg-info">Privada</span>
                                                {% endif %}
                                                <span class="badge bg-success">Activa</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <p class="card-text">{{ reservation.short_description }}</p>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar"></i> {{ reservation.date[:16] }}<br>
                                            <i class="fas fa-map-marker-alt"></i> {{ reservation.location }}<br>
                                            <i class="fas fa-users"></i> {{ reservation.guest_count }} invitados<br>
                                            <i class="fas fa-table"></i> {{ reservation.table_count }} mesa{% if reservation.table_count > 1 %}s{% endif %}
                                        </small>
                                    </p>
                                    
                                    {% if reservation.special_requirements %}
                                    <div class="mt-2">
                                        <small><strong>Requisitos especiales:</strong> {{ reservation.special_requirements }}</small>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex gap-2">
                                        <a href="{{ url_for('reservation_detail', reservation_id=reservation.id) }}" 
                                           class="btn btn-primary btn-sm">
                                            <i class="fas fa-eye"></i> Ver Detalles
                                        </a>
                                        {% if not reservation.is_cancelled %}
                                            <form method="POST" action="{{ url_for('cancel_reservation', reservation_id=reservation.id) }}">
                                                <button type="submit" class="btn btn-danger btn-sm" 
                                                        onclick="return confirm('¿Estás seguro de que quieres cancelar esta reserva?')">
                                                    <i class="fas fa-times"></i> Cancelar
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info text-center mt-4">
                        <i class="fas fa-plus-circle fa-2x mb-3"></i>
                        <h4>No has creado ninguna reserva</h4>
                        <p>Crea tu primera reserva para organizar un evento.</p>
                        <a href="{{ url_for('create_reservation') }}" class="btn btn-success">
                            <i class="fas fa-plus"></i> Crear Reserva
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.food-selections {
    max-height: 100px;
    overflow-y: auto;
    background-color: #f8f9fa;
    padding: 5px;
    border-radius: 4px;
    font-size: 0.85em;
}

.nav-tabs .nav-link {
    color: #495057;
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    font-weight: 600;
}

.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
}

.gap-2 {
    gap: 0.5rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const triggerTabList = [].slice.call(document.querySelectorAll('#myReservationsTabs button'));
    triggerTabList.forEach(function (triggerEl) {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            tabTrigger.show();
        });
    });
});
</script>
{% endblock %}